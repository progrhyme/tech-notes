---
title: "2020-05-09"
linkTitle: "2020-05-09"
date: 2020-05-09T15:48:56+09:00
---

## 5/9
### シェルスクリプトのドキュメントコメントをPODで書くのはもうやめていいかな

いつだったか、何かの本でそういう書き方を見てからずっとそうやってる。

例:

```sh
#!/usr/bin/env bash

:

exit 0

: <<'__EOF__'

=encoding utf8

=head1 NAME

B<my-script> - short description

=head1 DESCRIPTION

:

=cut

__EOF__
```

これでPODに食わせるとドキュメントとして解釈してくれるので、スクリプト内では `pod2text $0` とかでヘルプを表示できる。

…が、そろそろ `pod2text` がどの環境にも入っていると想定すべきでないかも…という気がしてきた。  
ところが、じゃあどう書いたらいいの？っていうのには決定版がない気がする。

シェルスクリプトにちゃんとコメントを書こうとしている人たちの間では、主に2つの派閥がある気がする:

1. スクリプトのヘッダや関数のヘッダとしてドキュメントコメントをそれなりのフォーマットで書きましょう派。[Googleのコーディング規約](https://google.github.io/styleguide/shellguide.html#s4.1-file-header)もこれ
1. `usage()` 関数内にヒアドキュメントで書きましょう派

いいとこ取りをしてる感じに見えるのは、 `usage()` 関数でコメントをパースしてヘルプっぽく出力してるもの。  
下のような例があった:

- [シェルスクリプトでヘルプメッセージをコメントに書いて表示する - Qiita](https://qiita.com/ngyuki/items/673d6cb3b36360eaf5cc)
- [自作シェルスクリプトにヘルプやらバージョンメッセージを実装？する面白い方法があった - Qiita](https://qiita.com/TomKid/items/ab49f8d0cd15b18e5e4a)

自分で独自フォーマットのコメントを書いている、という点では、下もこの類型にあたるか:

- [シェルスクリプト群のドキュメント書くの面倒だから自動でREADME.mdを生成する - Qiita](https://qiita.com/ssh0/items/0c14ee8949512a4dc98e)
- https://github.com/jmcantrell/bashful/blob/master/bin/shdoc

godocみたいなのないかな、と思って「shelldoc」とか「shdoc」とかでぐぐるとたくさん出てくる。

参考:

- [シェルスクリプト Tips | UNIX &amp; Linux コマンド・シェルスクリプト リファレンス](https://shellscript.sunone.me/tips.html)

### Microk8sを使ってみる

Ubuntu 18.04デスクトップ環境で、[4/29に昔入れていたminikubeをアンインストールしてしまった](../2020/20200429/#ubuntuに昔入れたminikubeをuninstall)のだが、また手元でさくっと試せるKubernetes環境が欲しくなった。

またminikubeを入れてもいいのだけど、Canonicalが[Microk8s](https://microk8s.io/)というのを出しており、これが使えそうだ。  
ちらっと見たところ、snapでインストール可能で簡単そうなので、こちらを試してみることにした。

[Quick start | MicroK8s](https://microk8s.io/docs/) に従ってセットアップする。

参考:

- [第560回 microk8sでお手軽Kubernetes環境構築：Ubuntu Weekly Recipe｜gihyo.jp … 技術評論社](https://gihyo.jp/admin/serial/01/ubuntu-recipe/0560)
- [遅ればせながらMicroK8sをためす - Qiita](https://qiita.com/numa_numa/items/798500668db59163f3b2)
- [MicroK8sを使ってみる - Qiita](https://qiita.com/niiku-y/items/e5285af4f12b1318cf4e)

#### 1. Install

snapでインストールする。

ガイドでは `--channel=1.18/stable` が示されていたが、他にどんなチャネルがあるのか気になったので、[Selecting a snap channel | MicroK8s](https://microk8s.io/docs/setting-snap-channel)を見つつ次のコマンドで確認した:

```sh
% snap info microk8s
name:      microk8s
summary:   Kubernetes for workstations and appliances
publisher: Canonical*
:
channels:
  latest/stable:    v1.18.2         2020-04-27 (1378) 201MB classic
  latest/candidate: v1.18.2         2020-04-30 (1383) 201MB classic
  latest/beta:      v1.18.2         2020-04-30 (1383) 201MB classic
  latest/edge:      v1.18.2         2020-05-07 (1399) 211MB classic
  dqlite/stable:    --
  dqlite/candidate: --
  dqlite/beta:      --
  dqlite/edge:      v1.16.2         2019-11-07 (1038) 189MB classic
  1.19/stable:      --
  1.19/candidate:   --
  1.19/beta:        --
  1.19/edge:        v1.19.0-alpha.1 2020-03-26 (1311) 201MB classic
  1.18/stable:      v1.18.2         2020-04-27 (1379) 201MB classic
  1.18/candidate:   v1.18.2         2020-04-27 (1379) 201MB classic
  1.18/beta:        v1.18.2         2020-04-27 (1379) 201MB classic
  1.18/edge:        v1.18.2         2020-04-29 (1387) 201MB classic
  :
```

今は latest/stable = 1.18/stable らしい。  
今後もstableのバージョンが上がったらsnapが勝手にアップデートしてくれることが期待できるので、 `latest/stable` チャネルを使うことにする。

```sh
$ sudo snap install microk8s --classic --channel=latest/stable
:
microk8s v1.18.2 from Canonical✓ installed
```

#### 2. Join the group

ログインユーザをmicrok8sグループに所属させる。

```sh
% grep microk8s /etc/group
microk8s:x:997:
% sudo usermod -a -G microk8s $USER
% sudo chown -f -R $USER ~/.kube
```

> You will also need to re-enter the session for the group update to take place

とのことなので、次を実行:

```sh
su - $USER
```

これをやると `$PATH` に `/snap/bin` が含まれなくなって `microk8s` コマンドが見つからなくなってしまったので、下を実行して解決:

```sh
% PATH=$PATH:/snap/bin
```

次回ログイン時にはこれは不要だろう。

#### 3. Check the status

```sh
% microk8s status --wait-ready
microk8s is running
addons:
cilium: disabled
dashboard: disabled
dns: disabled
fluentd: disabled
gpu: disabled
helm: disabled
helm3: disabled
host-access: disabled
ingress: disabled
istio: disabled
jaeger: disabled
knative: disabled
kubeflow: disabled
linkerd: disabled
metallb: disabled
metrics-server: disabled
prometheus: disabled
rbac: disabled
registry: disabled
storage: disabled
```

最初は必要最小限のインストールになっているそうだ。  
アドオンは後の手順で追加できる。

#### 4. Access Kubernetes

`microk8s kubectl` でkubectlと同じ操作ができる。

```sh
% microk8s kubectl get nodes
NAME            STATUS   ROLES    AGE   VERSION
ubuntu          Ready    <none>   13m   v1.18.2-41+b5cdb79a4060a3
% microk8s kubectl get services
NAME         TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE
kubernetes   ClusterIP   10.152.183.1   <none>        443/TCP   14m
```

kubectlをインストールしてないなら、下のようにaliasしておくと楽だよとのこと:

```sh
alias kubectl='microk8s kubectl'
```

私の環境にはkubectlをsnapでインストールしているので、これは保留で。

#### 5. Deploy an app

適当なイメージでDeploymentを作成する。

```sh
% microk8s kubectl create deployment kubernetes-bootcamp --image=gcr.io/google-samples/kubernetes-bootcamp:v1
deployment.apps/kubernetes-bootcamp created

% microk8s kubectl get pods
NAME                                   READY   STATUS              RESTARTS   AGE
kubernetes-bootcamp-6f6656d949-ggmrx   0/1     ContainerCreating   0          8s
```

#### 6. Use add-ons

下のようにして追加できる。今回はスキップした。

```sh
microk8s enable dns storage
```

#### 7. Starting and Stopping MicroK8s

microk8sをstop/startしてみる。

```sh
% microk8s stop
[sudo] パスワード:
Stopped.

% microk8s status
microk8s is not running. Use microk8s inspect for a deeper inspection.

% microk8s start
Started.
Enabling pod scheduling
node/ubuntu already uncordoned
```

さっき作ったPodも復活していた。

```sh
% microk8s kubectl get pods
NAME                                   READY   STATUS    RESTARTS   AGE
kubernetes-bootcamp-6f6656d949-ggmrx   1/1     Running   0          4m1s
```

#### Next Steps

簡単に使えて良い。  
実験用の環境としては全く問題なさそう。

マシンが複数あれば、マルチノードな環境も割と楽に作れそう。
これはVirtualboxなどの仮想マシンでもいいだろう。

[Multi-node MicroK8s | MicroK8s](https://microk8s.io/docs/clustering)
