---
title: "2020-05-02"
linkTitle: "2020-05-02"
date: 2020-05-02T00:06:02+09:00
---

## 5/2
### Bitbucket PipelinesでGCPに対してTerraformを適用するには

必要なもの:

- 必要な権限が付与されたService Account Key
- Cloud Resource Manager APIを有効化

手順:

1. Service Account Keyを作り、JSON形式で取得
1. 1. をBitbucketのリポジトリ変数にsecure変数として設定。キーはなんでもいいが、ここでは `GOOGLE_CREDENTIALS_DATA` とする。Base64化は不要
1. 下のような `bitbucket-pipelines.yml` を用意する

```YAML
image: hashicorp/terraform:0.12.24

pipelines:
  branches:
    staging:
      - step:
          script:
            - echo "${GOOGLE_CREDENTIALS_DATA}" > service-account-key.json
            - export GOOGLE_APPLICATION_CREDENTIALS=service-account-key.json
            - terraform init -input=false
            - terraform plan -input=false
    master:
      - step:
          script:
            - echo "${GOOGLE_CREDENTIALS_DATA}" > service-account-key.json
            - export GOOGLE_APPLICATION_CREDENTIALS=service-account-key.json
            - terraform init -input=false
            - terraform apply -input=false --auto-approve
```

`terraform plan` まで上手く行くことは試した。

NOTE:

- stagingブランチからmasterブランチにマージする前提
  - この向きでPRを作るといい
  - 任意のPRでPipelineを実行するのは、Bitbucket Pipelinesでは難しそう
    - Webhookと組合せて頑張ればできるかもしれないが、労力に見合うのか…？

参考:

- [2020-05-01に調べたログ]({{< ref "/a/memo/20200501.md" >}}#ciでgcpに対してterraformするには)
- [Terraform with Bitbucket pipeline](https://www.slideshare.net/MasatomoIto/terraform-with-bitbucket-pipeline) p.31
- [プル リクエストを使用したデプロイ- アトラシアン製品ドキュメント](https://ja.confluence.atlassian.com/bitbucket/deploy-with-pull-requests-856832274.html)
