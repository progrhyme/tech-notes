---
title: "2020-05-02"
linkTitle: "2020-05-02"
date: 2020-05-02T00:06:02+09:00
---

## 5/2
### Bitbucket PipelinesでGCPに対してTerraformを適用するには

必要なもの:

- 必要な権限が付与されたService Account Key
- Cloud Resource Manager APIを有効化

手順:

1. Service Account Keyを作り、JSON形式で取得
1. 1. をBitbucketのリポジトリ変数にsecure変数として設定。キーはなんでもいいが、ここでは `GOOGLE_CREDENTIALS_DATA` とする。Base64化は不要
1. 下のような `bitbucket-pipelines.yml` を用意する

```YAML
image: hashicorp/terraform:0.12.24

definitions:
  steps:
    - step: &terraform-plan
        name: terraform plan
        script:
          - echo "${GOOGLE_CREDENTIALS_DATA}" > service-account-key.json
          - export GOOGLE_APPLICATION_CREDENTIALS=service-account-key.json
          - terraform init -input=false
          - terraform plan -input=false
    - step: &terraform-apply
        name: terraform apply
        script:
          - echo "${GOOGLE_CREDENTIALS_DATA}" > service-account-key.json
          - export GOOGLE_APPLICATION_CREDENTIALS=service-account-key.json
          - terraform init -input=false
          - terraform apply -input=false --auto-approve

pipelines:
  branches:
    '**':
      - step: *terraform-plan
    master:
      - step: *terraform-plan
      - step:
          <<: *terraform-apply
          trigger: manual
```

上は、masterを除く任意のbranchに対する更新で `terraform plan` を実行し、master branchにおいては、 `terraform plan` を自動実行した後、マニュアルで `terraform apply` を実行する。

branch更新でなく、プルリクエスト駆動にすることもできる。  
上の例で、 `pipelines` 以下のみ、次のように変更してみる:

```YAML
pipelines:
  pull-requests:
    feature/*:
      - step: *terraform-plan

  branches:
    master:
      - step: *terraform-plan
      - step:
          <<: *terraform-apply
          trigger: manual
```

これで、 `feature/*` にマッチするbranchからのPRにより、 `terraform plan` が実行される。  
PRした後、branchを更新すればパイプラインが再実行される。

任意のbranchによるPRを対象にしたい場合は、 `feature/*` の代わりに `'**'` と記せば良い。

参考:

- [bitbucket-pipelines.yml の設定 - アトラシアン製品ドキュメント](https://ja.confluence.atlassian.com/bitbucket/configure-bitbucket-pipelines-yml-792298910.html)
- [YAML アンカー - アトラシアン製品ドキュメント](https://ja.confluence.atlassian.com/bitbucket/yaml-anchors-960154027.html)
- [2020-05-01に調べたログ]({{< ref "/a/memo/20200501.md" >}}#ciでgcpに対してterraformするには)
- [Bitbucketについてのメモ]({{< ref "/a/web-service/bitbucket.md" >}})

### YAMLで配列のマージはできなさそう

ハッシュのマージはアンカーとエイリアスでできるのだけど、配列のマージはできなさそう。

参考: [list - How to merge YAML arrays? - Stack Overflow](https://stackoverflow.com/questions/24090177/how-to-merge-yaml-arrays)

配列の1つ1つの要素にアンカーを付けて、再利用することは可能。

```YAML
- &mark foo
- bar
- *mark
- *mark
#=> ['foo', 'bar', 'foo', 'foo']
```

参考: [プログラマーのための YAML 入門 (初級編)](https://magazine.rubyist.net/articles/0009/0009-YAML.html#%E3%82%A2%E3%83%B3%E3%82%AB%E3%83%BC%E3%81%A8%E3%82%A8%E3%82%A4%E3%83%AA%E3%82%A2%E3%82%B9)

### DangerはBitbucketにどのように対応しているか

tfnotifyをBitbucketに対応させたいなーと思いながら、参考にできるかなと思って見ていた。

CIサーバからBitbucketのREST APIを叩いているようだ。

参考:

- [Bitbucket Server by HeEAaD · Pull Request #481 · danger/danger](https://github.com/danger/danger/pull/481/files)
- [Danger + BitBucket Cloud](https://danger.systems/js/usage/bitbucket_cloud.html)
