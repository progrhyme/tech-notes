---
title: "2020-05-16"
linkTitle: "2020-05-16"
date: 2020-05-16T01:56:37+09:00
---

## 5/16
### zshをfishっぽくいい感じにできた

[5/13にfishでちょっといいと思った機能はzshでもできそう](../20200513/#fishでちょっといいと思った機能はzshでもできそう)だと気がついたので、やってみた。  
…で、やってみたらできた。

作業環境はUbuntu 18.04.

やったこと:

1. oh-my-zshをインストール
1. テーマを選ぶ
1. shrink-pathを設定し、プロンプトをいい感じに調整
1. zsh-autosuggestionsをインストールして設定

1つずつ軽く振り返っておく。

#### oh-my-zshをインストール

https://github.com/ohmyzsh/ohmyzsh

README.mdの通りに。一応 tools/install.sh の中身はざっと見た。  
zshじゃないとデフォルトではchshされてしまうのと、インストール後に `zsh -l` が走ることは確認した上で、そのまま実行:

```sh
sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
```

元の ~/.zshrc は退避された上で、oh-my-zshが作った ~/.zshrc が配置されていることに気づいた。  
とりあえず自分の ~/.zshrc に戻して、oh-my-zshが作った ~/.zshrc の記述を ~/.zshenv と ~/.zshrc に追記する。

これだけでも `PROMPT` が変わって、見た目が変わったなという印象。

ただ、自分は `RPROMPT` に色々詰め込んでいるので、調整が必要。

プロンプトについては次とその次のステップで調整する。

#### テーマを選ぶ

https://github.com/ohmyzsh/ohmyzsh/wiki/Themes から選ぶ。  
Externalなテーマもあるらしいけど、今は興味なし。  
上から見ていって、[agnoster](https://github.com/agnoster/agnoster-zsh-theme)がよさげだったので、君に決めた。

これもデフォルトだと左PROMPTが長くて、しかもリポジトリのREADMEの通りにやろうとしても `AGNOSTER_*` な変数はセットされていない。

仕方ないので、`~/.oh-my-zsh/themes/agnoster.zsh-theme` で定義されている `build_prompt()` 関数を自分の ~/.zshrc の中でオーバーライドすることにした。

`agnoster.zsh-theme` を覗くと次のようになっていたので、それで行けそうだと思った。

```sh
$ tail ~/.oh-my-zsh/themes/agnoster.zsh-theme
## Main prompt
build_prompt() {
  RETVAL=$?
  prompt_status
  prompt_virtualenv
  prompt_aws
  prompt_context
  prompt_dir
  prompt_git
  prompt_bzr
  prompt_hg
  prompt_end
}

PROMPT='%{%f%b%k%}$(build_prompt) '
```

#### shrink-pathを設定し、プロンプトをいい感じに調整

shrink-pathは標準プラグインとしてoh-my-zshに同梱されている。

https://github.com/ohmyzsh/ohmyzsh/tree/master/plugins/shrink-path

このパスにREADME.mdも置かれているので、読むと使い方がわかる。

利用するには .zshrc 内で `plugins+=(shrink-path)` すればいい。

それから、 `PROMPT` や `RPROMPT` 内に `'$(shrink-path -f)'` と記すと、ホームディレクトリからの絶対パスで、親ディレクトリは先頭1文字に縮めて表示してくれる。

最終的に、agnoster.zsh-themeの `build_prompt()` 関数を次のように書き換えた:

```sh
build_prompt() {
  RETVAL=$?
  prompt_status
  prompt_segment blue $CURRENT_FG $(shrink_path -f)
  prompt_git
  prompt_end
}
```

これで下のような感じになった。

{{<figure src="ohmyzsh_capture.png" alt="terminal screenshot with oh-my-zsh">}}

#### zsh-autosuggestionsをインストールして設定

https://github.com/zsh-users/zsh-autosuggestions

INSTALL.md に従って、次のコマンドを実行:

```sh
git clone https://github.com/zsh-users/zsh-autosuggestions ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-autosuggestions
```

残念ながら今の環境は256色に対応してないみたいで、次のように設定した:

```sh
ZSH_AUTOSUGGEST_HIGHLIGHT_STYLE="fg=green,bold"
```

下のような感じでサジェストが出る。

{{<figure src="zsh_autosuggestions.png" alt="screenshot of zsh-autosuggestions">}}

`Ctrl+e` or `Ctrl+f` でサジェスト候補を選択できる。

参考:

- [ターミナルでコマンド履歴の入力補完 - Qiita](https://qiita.com/hinatades/items/d38be4830191f251935d)

もうこれは完全にfishと言っていいだろう。

…というか、自分にとってはfishをセットアップするより楽だった気がする。

今回の変更は次の2コミットに該当する:

- dotfilesの変更: https://github.com/progrhyme/myenv/commit/b4ef98a8b1ef9ae6f0a39532590d79c8161fc161
- セットアップスクリプトへの反映: https://github.com/progrhyme/myenv/commit/96a552660c9b79dcf73a1e87a8fc6664d33864f4

※oh-my-zshが勝手に `PAGER=less` と `LESS=-R` を設定していやがったので、.zshrc内でunsetしている。
